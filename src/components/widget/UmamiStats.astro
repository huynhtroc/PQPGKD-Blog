---
import WidgetLayout from "./WidgetLayout.astro";
import { Icon } from "astro-icon/components";

interface Props {
  class?: string;
  style?: string;
}
const { class: className, style } = Astro.props;
---

<WidgetLayout name="Thống kê lượt truy cập" id="umami-stats" class:list={[className]} {style}>
    <div class="text-center py-2">
        <div class="text-3xl font-bold text-neutral-900 dark:text-neutral-100 flex items-center justify-center gap-2">
            <Icon name="mdi:cursor-default-click" class="text-[1.4em] text-[var(--primary)]" />
            <span id="total-pageviews">-</span>
        </div>
        <div class="text-sm text-neutral-500 dark:text-neutral-400">Tổng lượt tương tác</div>
    </div>

    <div class="grid grid-cols-2 divide-x divide-neutral-200 dark:divide-neutral-700 text-center pt-2">
        <div class="px-2">
            <div class="text-xl font-bold text-neutral-900 dark:text-neutral-100 flex items-center justify-center gap-1.5">
                <Icon name="mdi:chart-line" class="text-[1.2em] text-[var(--primary)]" />
                <span id="total-visits">-</span>
            </div>
            <div class="text-sm text-neutral-500 dark:text-neutral-400">Số lượt truy cập</div>
        </div>
        <div class="px-2">
            <div class="text-xl font-bold text-neutral-900 dark:text-neutral-100 flex items-center justify-center gap-1.5">
                <Icon name="mdi:account-eye" class="text-[1.2em] text-[var(--primary)]" />
                <span id="total-visitors">-</span>
            </div>
            <div class="text-sm text-neutral-500 dark:text-neutral-400">Số người xem</div>
        </div>
    </div>

<script>
const lastStats = {
  pageviews: 0,
  visits: 0,
  visitors: 0
};

function formatNumber(num) {
    if (num >= 1_000_000) {
        return (num / 1_000_000).toFixed(1) + "M";
    }

    if (num >= 1_000) {
        return (num / 1_000).toFixed(1) + "K";
    }

    return num.toString();
}

function animateNumber(element, target, duration = 1800) {
    if (!element) return;

    const start = 0;
    const startTime = performance.now();

    function easeOutCubic(t) {
        return 1 - Math.pow(1 - t, 3);
    }

    function update(currentTime) {
        if (!document.body.contains(element)) return;

    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    const eased = easeOutCubic(progress);

    const value = Math.floor(start + (target - start) * eased);
    element.textContent = formatNumber(value);

        if (progress < 1) {
            requestAnimationFrame(update);
        }
    }

    requestAnimationFrame(update);
}

async function fetchStats() {
    try {
    const res = await fetch("/api/umami-stats/");
        if (!res.ok) throw new Error("Fetch failed");

    const data = await res.json();

    const pv = document.getElementById("total-pageviews");
    const v = document.getElementById("total-visits");
    const uv = document.getElementById("total-visitors");

    if (pv && data.pageviews !== lastStats.pageviews) {
        animateNumber(pv, data.pageviews || 0, 3200); 
            lastStats.pageviews = data.pageviews;
        }

    if (v && data.visits !== lastStats.visits) {
        animateNumber(v, data.visits || 0, 3500); 
            lastStats.visits = data.visits;
        }

    if (uv && data.visitors !== lastStats.visitors) {
        animateNumber(uv, data.visitors || 0, 3900); 
            lastStats.visitors = data.visitors;
        }
    } catch (err) {
    ["total-pageviews", "total-visits", "total-visitors"].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.textContent = "-";
        el.classList.add("text-red-500");
      }
    });
  }
}

document.addEventListener("DOMContentLoaded", fetchStats);
</script>


