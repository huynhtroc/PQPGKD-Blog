---
import { Icon } from "astro-icon/components";
import { announcementConfig } from "@/config/announcementConfig";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import WidgetLayout from "./WidgetLayout.astro";

const config = announcementConfig;

interface Props {
  class?: string;
  style?: string;
}
const className = Astro.props.class;
const style = Astro.props.style;
---

<!-- ç»„ä»¶æ˜¾ç¤ºçŽ°åœ¨ç”±sidebarLayoutConfigç»Ÿä¸€æŽ§åˆ¶ï¼Œæ— éœ€æ£€æŸ¥config.enable -->
<WidgetLayout
  name={config.title || i18n(I18nKey.announcement)}
  id="announcement"
  class={className}
  style={style}
>
  <div>
    <!-- å…¬å‘Šæ å†…å®¹ï¼ˆJS sáº½ thay ná»™i dung á»Ÿ Ä‘Ã¢yï¼‰ -->
    <div
      id="announcement-content"
      class="text-neutral-600 dark:text-neutral-300 leading-relaxed mb-3"
    >
      {config.content}
    </div>

    <!-- å¯é€‰é“¾æŽ¥å’Œå…³é—­æŒ‰é’® -->
    <div class="flex items-center justify-between gap-3">
      <div>
        {
          config.link && config.link.enable !== false && (
            <a
              href={config.link.url}
              target={config.link.external ? "_blank" : "_self"}
              rel={config.link.external ? "noopener noreferrer" : undefined}
              class="btn-regular rounded-lg px-3 py-1.5 text-sm font-medium active:scale-95 transition-transform"
            >
              {config.link.text}
            </a>
          )
        }
      </div>

      {
        config.closable && (
          <button
            class="btn-regular rounded-lg h-8 w-8 text-sm hover:bg-red-100 dark:hover:bg-red-900/30 transition-colors"
            onclick="closeAnnouncement()"
            aria-label={i18n(I18nKey.announcementClose)}
          >
            <Icon name="fa6-solid:xmark" class="text-sm" />
          </button>
        )
      }
    </div>
  </div>
</WidgetLayout>

<script>
  /* ===== Helpers ===== */

  const COUNTRY_MAP = {
  AF: "Afghanistan",
  AL: "Albania",
  DZ: "Algeria",
  AS: "American Samoa",
  AD: "Andorra",
  AO: "Angola",
  AI: "Anguilla",
  AQ: "Nam Cá»±c",
  AG: "Antigua vÃ  Barbuda",
  AR: "Argentina",
  AM: "Armenia",
  AW: "Aruba",
  AU: "Ãšc",
  AT: "Ão",
  AZ: "Azerbaijan",

  BS: "Bahamas",
  BH: "Bahrain",
  BD: "Bangladesh",
  BB: "Barbados",
  BY: "Belarus",
  BE: "Bá»‰",
  BZ: "Belize",
  BJ: "Benin",
  BM: "Bermuda",
  BT: "Bhutan",
  BO: "Bolivia",
  BA: "Bosnia vÃ  Herzegovina",
  BW: "Botswana",
  BR: "Brazil",
  BN: "Brunei",
  BG: "Bulgaria",
  BF: "Burkina Faso",
  BI: "Burundi",

  KH: "Campuchia",
  CM: "Cameroon",
  CA: "Canada",
  CV: "Cape Verde",
  KY: "Quáº§n Ä‘áº£o Cayman",
  CF: "Cá»™ng hÃ²a Trung Phi",
  TD: "Chad",
  CL: "Chile",
  CN: "Trung Quá»‘c",
  CO: "Colombia",
  KM: "Comoros",
  CG: "Congo",
  CD: "Congo (DC)",
  CR: "Costa Rica",
  CI: "Bá» Biá»ƒn NgÃ ",
  HR: "Croatia",
  CU: "Cuba",
  CY: "SÃ­p",
  CZ: "SÃ©c",

  DK: "Äan Máº¡ch",
  DJ: "Djibouti",
  DM: "Dominica",
  DO: "Cá»™ng hÃ²a Dominica",

  EC: "Ecuador",
  EG: "Ai Cáº­p",
  SV: "El Salvador",
  GQ: "Guinea XÃ­ch Äáº¡o",
  ER: "Eritrea",
  EE: "Estonia",
  ET: "Ethiopia",

  FI: "Pháº§n Lan",
  FJ: "Fiji",
  FR: "PhÃ¡p",

  GA: "Gabon",
  GM: "Gambia",
  GE: "Georgia",
  DE: "Äá»©c",
  GH: "Ghana",
  GR: "Hy Láº¡p",
  GL: "Greenland",
  GD: "Grenada",
  GU: "Guam",
  GT: "Guatemala",
  GN: "Guinea",
  GW: "Guinea-Bissau",
  GY: "Guyana",

  HT: "Haiti",
  HN: "Honduras",
  HK: "Há»“ng KÃ´ng",
  HU: "Hungary",

  IS: "Iceland",
  IN: "áº¤n Äá»™",
  ID: "Indonesia",
  IR: "Iran",
  IQ: "Iraq",
  IE: "Ireland",
  IL: "Israel",
  IT: "Ã",

  JM: "Jamaica",
  JP: "Nháº­t Báº£n",
  JO: "Jordan",

  KZ: "Kazakhstan",
  KE: "Kenya",
  KI: "Kiribati",
  KP: "Triá»u TiÃªn",
  KR: "HÃ n Quá»‘c",
  KW: "Kuwait",
  KG: "Kyrgyzstan",

  LA: "LÃ o",
  LV: "Latvia",
  LB: "Liban",
  LS: "Lesotho",
  LR: "Liberia",
  LY: "Libya",
  LI: "Liechtenstein",
  LT: "Litva",
  LU: "Luxembourg",

  MO: "Ma Cao",
  MG: "Madagascar",
  MW: "Malawi",
  MY: "Malaysia",
  MV: "Maldives",
  ML: "Mali",
  MT: "Malta",
  MH: "Quáº§n Ä‘áº£o Marshall",
  MR: "Mauritania",
  MU: "Mauritius",
  MX: "Mexico",
  FM: "Micronesia",
  MD: "Moldova",
  MC: "Monaco",
  MN: "MÃ´ng Cá»•",
  ME: "Montenegro",
  MA: "Ma Rá»‘c",
  MZ: "Mozambique",
  MM: "Myanmar",

  NA: "Namibia",
  NP: "Nepal",
  NL: "HÃ  Lan",
  NZ: "New Zealand",
  NI: "Nicaragua",
  NE: "Niger",
  NG: "Nigeria",
  NO: "Na Uy",

  OM: "Oman",

  PK: "Pakistan",
  PW: "Palau",
  PA: "Panama",
  PG: "Papua New Guinea",
  PY: "Paraguay",
  PE: "Peru",
  PH: "Philippines",
  PL: "Ba Lan",
  PT: "Bá»“ ÄÃ o Nha",
  PR: "Puerto Rico",

  QA: "Qatar",

  RO: "Romania",
  RU: "Nga",
  RW: "Rwanda",

  SA: "áº¢ Ráº­p Saudi",
  SG: "Singapore",
  SK: "Slovakia",
  SI: "Slovenia",
  ZA: "Nam Phi",
  ES: "TÃ¢y Ban Nha",
  LK: "Sri Lanka",
  SD: "Sudan",
  SE: "Thá»¥y Äiá»ƒn",
  CH: "Thá»¥y SÄ©",
  SY: "Syria",

  TW: "ÄÃ i Loan",
  TH: "ThÃ¡i Lan",
  TR: "Thá»• NhÄ© Ká»³",
  TN: "Tunisia",

  UA: "Ukraina",
  AE: "CÃ¡c Tiá»ƒu vÆ°Æ¡ng quá»‘c áº¢ Ráº­p Thá»‘ng nháº¥t",
  GB: "VÆ°Æ¡ng quá»‘c Anh",
  US: "Hoa Ká»³",
  UY: "Uruguay",
  UZ: "Uzbekistan",

  VN: "Viá»‡t Nam",
  VE: "Venezuela",

  YE: "Yemen",

  ZM: "Zambia",
  ZW: "Zimbabwe",
};

  function getCountryName(code) {
    return COUNTRY_MAP[code] || code || "";
  }

  /* ===== Vietnam city normalization (63 tá»‰nh / thÃ nh) ===== */

  const VIETNAM_CITY_MAP = {
    // ThÃ nh phá»‘ trá»±c thuá»™c TW
    "hanoi": "HÃ  Ná»™i",
    "ha noi": "HÃ  Ná»™i",

    "ho chi minh city": "TP. Há»“ ChÃ­ Minh",
    "hochiminh city": "TP. Há»“ ChÃ­ Minh",
    "ho chi minh": "TP. Há»“ ChÃ­ Minh",
    "saigon": "TP. Há»“ ChÃ­ Minh",
    "sai gon": "TP. Há»“ ChÃ­ Minh",

    "hai phong": "Háº£i PhÃ²ng",
    "da nang": "ÄÃ  Náºµng",
    "can tho": "Cáº§n ThÆ¡",
    "hue": "Thá»«a ThiÃªn Huáº¿",

    // Miá»n Báº¯c
    "ha giang": "HÃ  Giang",
    "cao bang": "Cao Báº±ng",
    "bac kan": "Báº¯c Káº¡n",
    "tuyen quang": "TuyÃªn Quang",
    "lao cai": "LÃ o Cai",
    "dien bien": "Äiá»‡n BiÃªn",
    "lai chau": "Lai ChÃ¢u",
    "son la": "SÆ¡n La",
    "yen bai": "YÃªn BÃ¡i",
    "thai nguyen": "ThÃ¡i NguyÃªn",
    "lang son": "Láº¡ng SÆ¡n",
    "quang ninh": "Quáº£ng Ninh",
    "bac giang": "Báº¯c Giang",
    "phu tho": "PhÃº Thá»",
    "vinh phuc": "VÄ©nh PhÃºc",
    "bac ninh": "Báº¯c Ninh",
    "hai duong": "Háº£i DÆ°Æ¡ng",
    "hung yen": "HÆ°ng YÃªn",
    "ha nam": "HÃ  Nam",
    "nam dinh": "Nam Äá»‹nh",
    "ninh binh": "Ninh BÃ¬nh",
    "hoa binh": "HÃ²a BÃ¬nh",

    // Báº¯c Trung Bá»™ & DuyÃªn háº£i Trung Bá»™
    "thanh hoa": "Thanh HÃ³a",
    "nghe an": "Nghá»‡ An",
    "ha tinh": "HÃ  TÄ©nh",
    "quang binh": "Quáº£ng BÃ¬nh",
    "quang tri": "Quáº£ng Trá»‹",
    "quang nam": "Quáº£ng Nam",
    "quang ngai": "Quáº£ng NgÃ£i",
    "binh dinh": "BÃ¬nh Äá»‹nh",
    "phu yen": "PhÃº YÃªn",
    "khanh hoa": "KhÃ¡nh HÃ²a",
    "ninh thuan": "Ninh Thuáº­n",
    "binh thuan": "BÃ¬nh Thuáº­n",

    // TÃ¢y NguyÃªn
    "kon tum": "Kon Tum",
    "gia lai": "Gia Lai",
    "dak lak": "Äáº¯k Láº¯k",
    "dak nong": "Äáº¯k NÃ´ng",
    "lam dong": "LÃ¢m Äá»“ng",

    // ÄÃ´ng Nam Bá»™
    "binh phuoc": "BÃ¬nh PhÆ°á»›c",
    "tay ninh": "TÃ¢y Ninh",
    "binh duong": "BÃ¬nh DÆ°Æ¡ng",
    "dong nai": "Äá»“ng Nai",
    "ba ria vung tau": "BÃ  Rá»‹a â€“ VÅ©ng TÃ u",

    // Äá»“ng báº±ng sÃ´ng Cá»­u Long
    "long an": "Long An",
    "tien giang": "Tiá»n Giang",
    "ben tre": "Báº¿n Tre",
    "tra vinh": "TrÃ  Vinh",
    "vinh long": "VÄ©nh Long",
    "dong thap": "Äá»“ng ThÃ¡p",
    "an giang": "An Giang",
    "kien giang": "KiÃªn Giang",
    "hau giang": "Háº­u Giang",
    "soc trang": "SÃ³c TrÄƒng",
    "bac lieu": "Báº¡c LiÃªu",
    "ca mau": "CÃ  Mau",
  };

  function normalizeVietnamCity(city) {
    if (!city) return "";

    const key = city
      .toLowerCase()
      .replace(/[\.,]/g, "")
      .trim();

    return VIETNAM_CITY_MAP[key] || city;
  }

  function getGreetingLocal() {
    const h = new Date().getHours();
    if (h >= 5 && h < 11) return "ChÃ o buá»•i sÃ¡ng â˜€ï¸";
    if (h >= 11 && h < 18) return "ChÃºc báº¡n buá»•i chiá»u vui váº» ðŸŒ¤ï¸";
    if (h >= 18 && h < 22) return "ChÃ o buá»•i tá»‘i ðŸŒ™";
    return "ChÃºc báº¡n ngá»§ ngon ðŸ˜´";
  }

  function getGreetingByTimezone(timezone) {
    try {
      const hour = new Date().toLocaleString("en-US", {
        timeZone: timezone,
        hour: "numeric",
        hour12: false,
      });

      const h = Number(hour);

      if (h >= 5 && h < 11) return "ChÃ o buá»•i sÃ¡ng â˜€ï¸";
      if (h >= 11 && h < 18) return "ChÃºc báº¡n buá»•i chiá»u vui váº» ðŸŒ¤ï¸";
      if (h >= 18 && h < 22) return "ChÃ o buá»•i tá»‘i ðŸŒ™";
      return "ChÃºc báº¡n ngá»§ ngon ðŸ˜´";
    } catch {
      return getGreetingLocal();
    }
  }

  /* ===== Announcement content ===== */

  async function updateAnnouncement() {
    const el = document.getElementById(
      "announcement-content"
    ) as HTMLElement | null;
    if (!el) return;

    try {
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 3000);

      const res = await fetch("https://ipinfo.io/json", {
        signal: controller.signal,
      });

      clearTimeout(timeout);
      if (!res.ok) throw new Error("ipinfo failed");

      const data = await res.json();

      const greeting = data.timezone
        ? getGreetingByTimezone(data.timezone)
        : getGreetingLocal();

      const city =
        data.country === "VN"
          ? normalizeVietnamCity(data.city)
          : data.city || "";

      const country = getCountryName(data.country);

      el.innerHTML = `
        <div>${greeting}</div>
        ${
          city && country
            ? `<div class="mt-1">
                Má»«ng báº¡n Ä‘áº¿n tá»« <b>${city}</b>, <b>${country}</b> Ä‘Ã£ á»Ÿ Ä‘Ã¢y ðŸ’–
              </div>`
            : ""
        }
      `;
    } catch {
      el.innerHTML = `<div>${getGreetingLocal()}</div>`;
    }
  }

  /* ===== Close logic ===== */

  function closeAnnouncement() {
    const widgetLayout = document.querySelector(
      'widget-layout[data-id="announcement"]'
    ) as HTMLElement | null;

    if (widgetLayout) {
      widgetLayout.style.display = "none";
      localStorage.setItem("announcementClosed", "true");
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const widgetLayout = document.querySelector(
      'widget-layout[data-id="announcement"]'
    ) as HTMLElement | null;

    if (widgetLayout && localStorage.getItem("announcementClosed") === "true") {
      widgetLayout.style.display = "none";
      return;
    }

    updateAnnouncement();
  });

  window.closeAnnouncement = closeAnnouncement;
</script>


